#!/bin/bash
set -e

if [ $(id -u) != 0 ] && [ ! -v DISPLAY ] && [ ! -e $SNAP_COMMON/login-session-control.connected ]; then
  echo "ERROR: You need one of: root, a DISPLAY, or to connect the login-session-control interface."
  echo ""
  echo "To connect the login-session-control interface and add to the login menu:"
  echo "  /snap/egmde-confined-desktop/current/bin/setup.sh"
  exit 1
fi

export XDG_RUNTIME_DIR=$(dirname $XDG_RUNTIME_DIR)
mkdir -p $XDG_RUNTIME_DIR -m 700
mkdir -p $XDG_CACHE_HOME

mkdir -p /tmp/.X11-unix

# We need to stop Mir accessing any existing X11 session.
# Mir detects existing sessions my scanning /tmp/.X11-unix
# but we don't have the real /tmp, but a snap specific one.
# So fake the existing $DISPLAY in the fake /tmp/.X11-unix
if [ -z "${DISPLAY}" ]
then touch /tmp/.X11-unix/X${DISPLAY:1}
fi
# A few more for luck
touch /tmp/.X11-unix/X0
touch /tmp/.X11-unix/X1
touch /tmp/.X11-unix/X2
touch /tmp/.X11-unix/X3
touch /tmp/.X11-unix/X4

cd $HOME
exec $SNAP/bin/egmde $@

